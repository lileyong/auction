T.recharge=function(){var i=Global.isAudit&&"1"==Global.isAudit?"元":"币",r=parseFloat($("#recharge-money").val()),a=0,o=[],u=[],n=0;T.isDoRecharge=!1,T.hasCallBack=!1;var s=function(e){if(""!=e)return!0;tip("请输入充值金额")},h={init:function(){h.initPage(),h.loadCache(),h.loadList(),h.bindEvent(),h.refreshUserMoney(5)},initPage:function(e){var t=T.Storage.get("access_token"),a=T.Storage.get("userinfo")||{};a&&t||e?($("#account").text(a.nickName||a.userMobile||"--"),$("#balance").text(a.moneyList?a.moneyList[2]:"--")):T.Util.openWindow(T.Util.getRootPath()+"/"+Global.webRoot+"/user/login.html"),Global.isAudit&&"1"==Global.isAudit&&($(".coinunit").text("元"),$("#account-type").text("账户余额"))},loadCache:function(){var e=T.Storage.get("recharge_quick"),t=T.Storage.get("recharge_list");if(e){$("#recharge-quick").html(e);var a=parseFloat(T.Util.getPara("money")||$("#recharge-quick em.on").text()).toFixed(2);$("#recharge-money").val(a),$.each($("#recharge-quick em"),function(e){var t=$("#recharge-quick em").eq(e);parseFloat(t.text())==parseFloat(a)&&($("#recharge-quick em").removeClass("on"),t.addClass("on"))}),u=T.Storage.get("redPackList")||[];var r=h.getCutMoney(a);$("#gain-money").text(a+i),$("#cut-money").text(r+i),$("#pay-money").text((a-r).toFixed(2)+"元"),$("#recharge-quick,#payinfo").removeClass("hide")}t&&$("#recharge-list").html(t),$("#payinfo,#recharge-list,#recharge-text").removeClass("hide"),h.bindEvent()},bindEvent:function(){$("#recharge-money").on("input",function(){var e=$(this).val();if(0<e.length?$(this).parent().addClass("writing"):$(this).parent().removeClass("writing"),T.money||(T.money=""),e.length>=T.money.length&&(!e.slice(-1).match(/[0-9.]/)||e.match(/\.\d{3}/)))return $(this).val(T.money),!1;T.money=e,r=parseFloat($(this).val())||0;var t=h.getCutMoney(r);$("#recharge-quick em").removeClass("on"),$("#gain-money").text(h.getTotalMoney()),$("#cut-money").text(t+i),$("#pay-money").text((r-t).toFixed(2)+"元"),$.each($("#recharge-quick em"),function(e){var t=$("#recharge-quick em").eq(e);parseFloat(t.text())==r&&t.addClass("on").siblings().removeClass("on")})}),$("#recharge-money").on("blur",function(){$(this).parent().parent().removeClass("writing")}),$(".clear").off().Touch(function(){T.money="",$("#gain-money").text("0.00"),$(this).parent().find("input").val(""),$(this).parent().removeClass("writing")}),$("#recharge-quick em").off().Touch(function(){$(this).addClass("on").siblings().removeClass("on"),r=parseFloat($(this).text());var e=h.getCutMoney(r);$("#recharge-money").val(r),$("#gain-money").text(h.getTotalMoney()),$("#cut-money").text(e+i),$("#pay-money").text((r-e).toFixed(2)+"元")}),$(".recharge-item").off().Touch(function(){var e=T.Util.trim($("#recharge-money").val()),t=JSON.parse($(this).attr("data-obj"));if(!s(e))return!1;h.doRecharge({rec_no:t.REC_NO,rec_code:t.REC_CODE,is_form:t.isForm,rechargeMoney:e,successCallbackUrl:t.SYN_S_URL})})},refreshUserMoney:function(t){T.User.getUInfo(function(){var e=T.Storage.get("userinfo")||{};e.moneyList&&$("#balance").html()!=e.moneyList[2]?$("#balance").text(e.moneyList?e.moneyList[2]:"--"):(n++,t&&n<t?setTimeout(function(){h.refreshUserMoney(t)},2e3):!t&&n<11&&setTimeout(function(){h.refreshUserMoney()},1200))},1)},getTotalMoney:function(){var e=Number(r).toFixed(2)+i;if(o&&o.length)for(var t=0;t<o.length;t++)"3"==a?r==o[t].START_MONEY&&(e+="+"+Number(o[t].GIVE_MONEY).toFixed(2)+"赠币"):r>=o[t].START_MONEY&&r<o[t].END_MONEY&&("1"==a?e+="+"+Number(o[t].GIVE_MONEY).toFixed(2)+"赠币":"2"==a&&(e+="+"+Number(r*o[t].GIVE_MONEY/100).toFixed(2)+"赠币"));return e},getCutMoney:function(e){for(var t=0;t<u.length;t++){var a=u[t];if(Number(e)>=Number(a.minMoney)&&Number(e)<Number(a.maxMoney))return a.redPack}return 0},loadList:function(){T.Util.xmlHttpRequest({type:"get",authError:1,reqUrl:"/commodity/services/acct/recList?deviceType="+T.Util.getDeviceType()+"&channelCd="+T.Util.getAppInfo("channelCode")+"&appVersion="+T.Util.getAppInfo("appVersion")+"&isH5="+(T.isNative?"0":"1")+"&platform="+T.Util.getPlatform(),callback:function(e){"0"==e.msg_code&&e.res_data?(a=e.res_data.ruleType,o=e.res_data.ruleList,h.showRechargeList(e.res_data)):tip(e.msg||Global.neterror)},errorCallback:function(){}})},showRechargeList:function(o){o.ruleTotal&&$("#advert").text(o.ruleTotal);var n=o.recButton||[],s=[],c=T.Util.getParaSearch("money"),l=0;if($.each(n,function(e,t){Global.isAudit&&"1"==Global.isAudit&&(t.BUTTON_NAME=t.BUTTON_NAME.replace(/拍币/,"元"));var a="";if(T.Util.isEmpty(c)||"NaN"==c)if(o.ruleList&&o.ruleList.length){var r=function(){for(var e=0;e<n.length;e++)if(n[e].BUTTON_GIFT)return String(e)}();r&&(l=parseFloat(n[r].BUTTON_NUMBER),a=e==r?' class="on"':"")}else t.IS_DEFAULT?(l=parseFloat(t.BUTTON_NUMBER),a=' class="on"'):(l=parseFloat(n[0].BUTTON_NUMBER),a=0==e?' class="on"':"");else{var i=function(e){for(var t=0;t<n.length;t++)if(parseFloat(n[t].BUTTON_NUMBER)>=e)return String(t)}(c);i?(l=parseFloat(n[i].BUTTON_NUMBER),a=e==i?' class="on"':""):(l=c,a=parseFloat(t.BUTTON_NAME)==c?' class="on"':"")}s.push("<em"+a+">"+t.BUTTON_NAME+(t.BUTTON_GIFT?"<span>"+t.BUTTON_GIFT+"</span>":"")+"</em>")}),$("#recharge-quick").html(s.join("")),T.Storage.set("recharge_quick",$("#recharge-quick").html()),u=o.redPackList||[],T.Storage.set("redPackList",u),l){r=Number(l);var e=h.getCutMoney(r);$("#recharge-money").val(Number(l).toFixed(2)),$("#gain-money").text(h.getTotalMoney()),$("#cut-money").text(e+i),$("#pay-money").text((r-e).toFixed(2)+"元")}var t=o.recList||[],a=[];$.each(t,function(e,t){a.push('<div class="recharge-item" data-obj=\''+JSON.stringify(t)+"'><i style=\"background:url("+T.Util.getFullPic(t.REC_PIC)+') left center / 0.72rem auto no-repeat;"></i>'+t.JOIN_INFO+"</div>")}),$("#recharge-list").html(a.join("")),T.Storage.set("recharge_list",$("#recharge-list").html()),$("#recharge-quick,#payinfo,#recharge-list,#recharge-text").removeClass("hide"),h.bindEvent()},showTips:function(){h.refreshUserMoney();confirm({className:"recharge_alert",html:"<h2>充值信息</h2><p>如确认已付款请勿重复支付，可能存在延迟到账，请稍后查看“账户明细”是否充值成功；如未付款，请继续充值</p>",cancelText:"已完成付款",okText:"继续充值",okFun:function(){},cancelFun:function(){T.Util.back()}})},alipayRechargeCallback:function(e){T.Util.xmlHttpRequest({type:"get",errorType:1,reqUrl:"/notify/alipayRechargeCallback?orderNo="+e,callback:function(e){T.Util.back()}})},doRecharge:function(e){r=e.rechargeMoney;var i=e.rec_code,o=parseInt(e.is_form),t=e.successCallbackUrl;/^alipay/.test(i)||/^wechat/.test(i)?T.isH5Pay=!1:T.isH5Pay=!0,T.isDoRecharge=!0,clearTimeout(T.showRechargeTips);var a={rechargeMoney:r,rechargeType:i,successCallbackUrl:t,failCallbackUrl:t,subject:"拍币",describe:"拍币充值",payTimeout:"100000",appCd:T.Util.getAppInfo("bundleID"),appName:T.Util.getAppInfo("appName"),channelCd:T.Util.getAppInfo("channelCode"),appVersion:T.Util.getAppInfo("appVersion"),client_os:Global.isiOS?"ios":"Android",joinType:"0",userIp:"127.0.0.1"};!1,tip("加载中...","loading"),T.Util.xmlHttpRequest({type:"post",errorType:1,reqUrl:"/commodity/services/acct/rechargeMode",reqData:a,callback:function(e){pageLoading.hide(),!0,T.hasCallBack=!1;var a=T.Util.getParaSearch("from");if(e.res_data&&e.res_data.data)if(/^alipay/.test(i))T.Util.aliPay({payOrder:Base64.encode(e.res_data.data)},function(e){T.hasCallBack=!0,T.isDoRecharge=!1;var t=JSON.parse(Base64.decode(e.data));t&&"9000"==t.resultStatus?(tip("充值成功","ok"),h.refreshUserMoney(),h.loadList(),h.alipayRechargeCallback(JSON.parse(t.result).alipay_trade_app_pay_response.out_trade_no)):(tip("充值失败","error"),"buy"==a&&T.Util.back())});else if(/^wechat/.test(i))T.Util.weixinPay(e.res_data.data,function(e){T.hasCallBack=!0,T.isDoRecharge=!1,e.data&&0==e.data.errCode?(tip("充值成功","ok"),h.refreshUserMoney(),h.loadList(),T.Util.back()):(tip("充值失败","error"),"buy"==a&&T.Util.back())});else{var t=JSON.parse(e.res_data.data),r=t.payurl||t.url;o&&(r=T.Util.getRootPath()+"/"+Global.webRoot+"/user/rechargeForm.html",T.Storage.set("payData",t)),Global.isiOS&&T.isNative?T.Util.openWindow(Base64.encode(r+(-1<r.indexOf("?")?"&":"?")+"JPNativeTitle="+encodeURIComponent("充值")),{isBase64Encode:1}):T.Util.openWindow(r+(-1<r.indexOf("?")?"&":"?")+"JPNativeTitle=充值")}else T.isDoRecharge=!1,tip(Global.neterror,"error")},errorCallback:function(e){pageLoading.hide(),!0,T.hasCallBack=!1,setTimeout(function(){e&&e.msg?tip(e.msg):tip(Global.neterror,"error")},500)}})}};return{init:h.init,initPage:h.initPage,showTips:h.showTips}}(),$(document).ready(function(){T.isNative?T.appToH5.init(function(){T.recharge.init()},function(){T.recharge.initPage(!0),T.isH5Pay&&T.isDoRecharge&&(T.isDoRecharge=!1,T.recharge.showTips())},function(){},function(){},function(){var e=T.Util.getParaSearch("from");T.isH5Pay?("buy"==e?T.Util.back({num:2}):T.Util.back({num:1}),T.isDoRecharge=!1,T.recharge.showTips()):("buy"==e&&T.Util.back(),T.showRechargeTips=setTimeout(function(){!T.hasCallBack&&T.isDoRecharge&&(T.isDoRecharge=!1,T.recharge.showTips())},50))}):T.recharge.init()});