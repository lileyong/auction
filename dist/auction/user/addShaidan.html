<!DOCTYPE html><html lang="en" class="white"><head><meta charset="utf-8"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="yes" name="apple-touch-fullscreen"><meta content="telephone=no,email=no" name="format-detection"><meta name="Cache-Type" content="image/gif,image/png,image/jpg"><meta http-equiv="X-UA-Compatible" content="IE=edge"><title>添加晒单</title><meta name="description" content=""><meta name="keywords" content="index"><meta name="renderer" content="webkit"><meta http-equiv="Cache-Control" content="no-siteapp"><meta name="apple-mobile-web-app-title" content=""><script src="../js/flexible.js"></script><script src="../js/flexible_css.js"></script><link rel="stylesheet" href="../css/main.css"><link rel="stylesheet" href="../css/buy.css"><link rel="stylesheet" href="../css/imageViewer.css"></head><body class="white"><div class="navbar"><div class="back_arrow back_home" id="back"></div><h1 id="titleStr">--</h1><div id="rightBtn">确定</div></div><div class="mainContent" id="main"><div id="addshaidan-box"><div id="addshaidan-textarea"><textarea id="shaidan-comment" maxlength="300" placeholder="晒出中奖好评及图片，将获得不同的赠币奖励哦，特别好评可获惊喜赠币奖励。"></textarea><div id="shaidanTips">至少<em>5</em>个字哦</div></div><div id="addshaidan-imglist"><div class="imgitem" id="addImg"><img src="../img/usercenter/icon_addimg.png"></div></div><div id="addshaidan-star"><h2>商品评价</h2><p><i class="star"></i><i class="star"></i><i class="star"></i><i class="star"></i><i class="star"></i></p></div><form name="formFile" enctype="multipart/form-data" style="position:absolute;bottom:0;opacity:0"><div class="status-img" id="fileLeft"><img src="" class="status-pic" value="p_pic"> <input type="file" accept="image/*" class="file" src="" name="fileToUpLoad" value="p_pic" multiple> <input type="file" name="src" value="2"></div></form></div></div><div id="viewer" class="hidden"><div class="navbar"><div class="back_arrow back_home" id="viewBack"></div><h1 id="viewTitle">1/4</h1><span id="delete"></span></div><div id="viewBox"><div id="imgList"></div></div><div id="deleteBox" class="hidden"><h2>要删除这张照片吗？</h2><div class="deleteBtn" id="deleteOk">删除</div><div class="deleteBtn" id="deleteCancel">取消</div></div></div><script src="../js/zepto.min.js"></script><script src="../js/main.js"></script><script src="../js/Exif.js"></script><script>var base64Image=function(e){var i=e.file,n=e.width?e.width:750,d=e.ratio?e.ratio:.75,s=e.callback?e.callback:null;if(window.FileReader){var t=i,a=new FileReader,o=null;EXIF.getData(t,function(){o=EXIF.getTag(this,"Orientation"),a.readAsDataURL(t)}),a.onloadstart=function(){},a.onerror=function(){},a.onload=function(){i.value="";var a=new Image;a.src=this.result,a.onload=function(){var e=document.createElement("canvas"),i=a.width/a.height;6==o?(e.width=a.height<n?a.height:n,e.height=parseInt(e.width*i),e.getContext("2d").rotate(90*Math.PI/180),e.getContext("2d").drawImage(a,0,0,a.width,a.height,0,-e.width,e.height,e.width)):8==o?(e.width=a.height<n?a.height:n,e.height=parseInt(e.width*i),e.getContext("2d").rotate(-90*Math.PI/180),e.getContext("2d").drawImage(a,0,0,a.width,a.height,-e.height,0,e.height,e.width)):(3==o?(e.width=a.width<n?a.width:n,e.height=parseInt(e.width/i),e.getContext("2d").translate(e.width,0),e.getContext("2d").scale(-1,1),e.getContext("2d").translate(0,e.height),e.getContext("2d").scale(1,-1)):(e.width=a.width<n?a.width:n,e.height=parseInt(e.width/i)),e.getContext("2d").drawImage(a,0,0,a.width,a.height,0,0,e.width,e.height));var t=e.toDataURL("image/jpeg",d);s&&s(t)}}}else alert("请升级浏览器")};function convertBase64UrlToBlob(e){for(var i=e.split(","),t=i[0].match(/:(.*?);/)[1],a=atob(i[1]),n=a.length,d=new Uint8Array(n);n--;)d[n]=a.charCodeAt(n);return new Blob([d],{type:t})}T.addShandai=function(){var l=[],d=T.Util.getPara("type"),s=!0,h={init:function(){h.bindEvent(),"shaidan"!=d?$("#titleStr").html("添加评价"):$("#titleStr").html("添加晒单"),Global.isAndroid&&$("input[name='fileToUpLoad']").attr("capture","camera")},bindEvent:function(){var r;$("#addImg").off().Touch(function(){3<l.length?tip("最多上传3张图片","error"):$(".file").trigger("click")}),$(".file").change(function(){var e=$(this),i=e[0],t=window.URL||window.webkitURL;if(i&&i.files&&0<i.files.length){var a=$("#addshaidan-imglist .imgitem").length-1;3<=a+i.files.length&&$("#addImg").hide();for(var n=0;n<i.files.length;n++)if(2<a+n)tip("最多上传3张图片","error");else{var d=i.files[n];if(d.type.match("image.*")){for(var s=!1,o=0;o<l.length;o++)if(l[o].name==d.name&&l[o].size==d.size&&l[o].lastModified==d.lastModified){tip("不能上传同样的图片哦","error"),s=!0;break}if(!s)if(console.log("压缩前"+d.size/1024+"kb"),200<d.size/1024){base64Image({width:750,ratio:.75,file:d,callback:function(e){$("#addshaidan-imglist").prepend('<div class="imgitem"><img src="'+e+'"></div>'),$("#viewer #imgList").prepend('<div class="imgitem" data-index="'+$("#viewer #imgList .imgitem").length+'"><div class="imgcell"><img src="'+e+'"></div></div>');var i=convertBase64UrlToBlob(e);l.push(i),console.log("压缩后"+i.size/1024+"kb"),setTimeout(function(){h.initImgScroll(0),h.showShaidanTips()},10),h.bindImgEvent()}})}else r=t.createObjectURL(d),$("#addshaidan-imglist").prepend('<div class="imgitem"><img src="'+r+'"></div>'),$("#viewer #imgList").prepend('<div class="imgitem" data-index="'+$("#viewer #imgList .imgitem").length+'"><div class="imgcell"><img src="'+r+'"></div></div>'),l.push(d),setTimeout(function(){h.initImgScroll(0),h.showShaidanTips()},10),h.bindImgEvent()}else tip("只能上传图片哦","error")}}else r=e.val()}),$("#viewBack").off().Touch(function(){$("#viewer,#deleteBox").addClass("hidden")}),$("#addshaidan-star  p i").off().Touch(function(){var e=0,i=[];e=$(this).index()?$(this).index()+1:$(this).is(".star")?0:1,i.push(T.Util.repeat('<i class="star"></i>',e)),i.push(T.Util.repeat("<i></i>",5-e)),$(this).parent().html(i.join("")),h.bindEvent()}),$("#rightBtn").off().Touch(function(){var e=T.Util.trim($("#shaidan-comment").val());T.Util.isEmpty(e)&&0==l.length?"shaidan"==d?tip("请输入您中奖的感想"):tip("请输入您评论的内容"):!T.Util.isEmpty(e)&&e.length<5?tip("最少填写5个字哦~"):h.doUpload()}),$("#shaidan-comment").on("input",function(){h.showShaidanTips()})},bindImgEvent:function(){$("#addshaidan-imglist .imgitem").not("#addImg").off().Touch(function(){$("input,textarea").blur(),h.initImgScroll($(this).index()),$("#viewer").removeClass("hidden"),setTimeout(function(){$(".navbar").addClass("slideUp")},600)}),$("#addshaidan-imglist .imgitem").not("#addImg").Touch(function(){var e=$("#addshaidan-imglist .imgitem").length,i=$(this).index(),t=e-$(this).index()-2;$(this).find(".delete").length?$(this).find(".delete").remove():$(this).append('<i class="delete"></i>'),$("#addshaidan-imglist .imgitem .delete").off().Touch(function(){l.splice(t,1),$("#viewer #imgList .imgitem").eq(i).remove(),$("#addshaidan-imglist .imgitem").eq(i).remove(),$("#addshaidan-imglist .imgitem").length<4&&$("#addImg").show(),h.showShaidanTips()},{stop:!0})},{isLongPress:!0}),$("#delete").off().Touch(function(){$("#deleteBox").removeClass("hidden")}),$("#deleteOk").off().Touch(function(){var e=parseInt($("#viewer .imgitem").eq(T.viewerIndex).attr("data-index"));l.splice(e,1),$("#viewer #imgList .imgitem").eq(T.viewerIndex).remove(),$("#addshaidan-imglist .imgitem").eq(T.viewerIndex).remove(),$("#deleteBox").addClass("hidden"),setTimeout(function(){$("#viewer #imgList .imgitem").length?h.initImgScroll(T.viewerIndex):$("#viewer,#deleteBox").addClass("hidden"),h.showShaidanTips(),$("#addImg").show(),setTimeout(function(){tip("已删除","ok")},300)},10)}),$("#deleteCancel").off().Touch(function(){$("#deleteBox").addClass("hidden")})},showShaidanTips:function(){var e=$("#shaidan-comment").val(),i="";i=$("#addshaidan-imglist .imgitem").length<=1?""==e?"至少<em>5</em>个字哦":e.length<5?"加油，再写<em>"+(5-e.length)+"</em>个字就有机会赢得<em>3</em>赠币":e.length<15?(5<e.length?"加油，":"")+"再加<em>"+(15-e.length)+"</em>个字，就有机会赢得<em>4</em>赠币":"添加图片，就有机会赢得<em>8</em>赠币":e.length<15?"添加<em>15</em>字评论，就有机会赢得<em>8</em>赠币":"评论细腻，拍摄完整，描述优秀，就有机会赢得惊喜赠币奖励哦",$("#shaidanTips").html(i)},initImgScroll:function(e){var i=$("#viewer #imgList .imgitem").length;e<0?e=0:i-1<e&&(e=i-1),T.viewerIndex=e,$("#viewTitle").text(e+1+"/"+i),h.imgScroll(i,e)},imgScroll:function(i,t){var d=!1,s=!0,o=!0,r=0,l=0,h=0,g=0,m=0,c=0,f=0,p=0,u=(t=t,window.innerWidth),v=$("#imgList").css({marginLeft:-t*u+"px",width:10*i+"rem"});v.off().on("touchstart",function(e){e.preventDefault(),$("#deleteBox").addClass("hidden"),setTimeout(function(){d||$(".navbar").toggleClass("slideUp")},10);try{r=e.changedTouches[0].clientX,m=e.changedTouches[0].clientY,h=parseInt(v.css("margin-left")),f=parseInt(v.css("padding"))}catch(e){}}),v.on("touchmove",function(e){e.preventDefault();try{l=e.changedTouches[0].clientX,c=e.changedTouches[0].clientY,g=parseInt(v.css("margin-left")),p=parseInt(v.css("padding"));var i=.8-Math.abs((g-h)/u),t=.2-Math.abs((p-f)/u),a=g+.8*i*i*(l-r),n=p+5*t*t*(c-m);console.log(n+"px 0",c-m),Math.abs(l-r)>=Math.abs(c-m)?s&&(v.css({"margin-left":a+"px"},500),o=!1):o&&(s=!1),1<l-r||1<c-m?(d=!0,$(".navbar").addClass("slideUp")):(d=!1,$(".navbar").toggleClass("slideUp"))}catch(e){}}),v.on("touchend",function(e){e.preventDefault();try{d=!1,g=parseInt(v.css("margin-left")),(t=h<g?Math.floor(-g/u):Math.ceil(-g/u))<0?t=0:i-1<t&&(t=i-1),T.viewerIndex=t,$("#viewTitle").text(t+1+"/"+i),Math.abs(l-r)>Math.abs(c-m)?v.animate({"margin-left":-t*u+"px"},500):$("#mallbanner").animate({padding:"0"},500),o=s=!0}catch(e){}})},doUpload:function(){tip("正在上传","loading");for(var e,i=new FormData,t=0;e=l[t];t++)console.log(e.size),i.append("files",e,(new Date).getTime()+e.type.replace("image/","."));var a=T.Util.getPara("orderNo");"shaidan"==d&&(a=T.Util.getPara("expectId")),i.append("EXPECT_ID",a),i.append("COMMODITY_ID",T.Util.getPara("id")),i.append("SHARE_DESC",$("#shaidan-comment").val()),i.append("LEVEL",$(".star").length);var n=3;if("shaidan"==d&&(n=2),$("textarea").blur(),!s)return!1;s=!1,$.ajax({url:Global.fullHost+"/order/services/servlet/shareOrder?signKey=f95fd9e45de9463186f0984f9b5e0962&type="+n,type:"POST",data:i,async:!1,cache:!1,contentType:!1,processData:!1,headers:{Authenticate:T.Storage.get("access_token")},success:function(e){if(s=!0,pageLoading.hide(),e&&"0"==e.msg_code){var i={type:d,shaidanNo:a};T.Storage.set("shaidanSucInfo",i),setTimeout(function(){"shaidan"!=d?tip("评价成功","ok"):tip("晒单成功","ok")},500),setTimeout(function(){T.Util.back()},3e3)}else tip(e.msg||Global.neterror,"error")},error:function(e){s=!0,pageLoading.hide(),tip(e.msg||Global.neterror,"error")}})}};return{init:h.init}}(),$(document).ready(function(){T.isNative?T.appToH5.init(function(){T.addShandai.init()},function(){},function(){},function(){},function(){}):T.addShandai.init()})</script></body></html>